<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>RuangCurhat - Aman & Rahasia</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #f8f9fd;
            --bg-gradient: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            --primary: #6c5ce7;
            --primary-grad: linear-gradient(135deg, #6c5ce7 0%, #a29bfe 100%);
            --secondary: #00cec9;
            --text-main: #2d3436;
            --text-muted: #636e72;
            --card-bg: #ffffff;
            --input-bg: #f1f2f6;
            --border: #dfe6e9;
            --shadow: 0 10px 30px rgba(0,0,0,0.05);
            --danger: #ff7675;
            --success: #00b894;
            --warning: #fdcb6e;
            --container-padding: 20px;
            --border-radius-lg: 20px;
            --border-radius-md: 12px;
            --border-radius-sm: 8px;
        }

        [data-theme="dark"] {
            --bg-color: #1e1e2e;
            --bg-gradient: linear-gradient(135deg, #0f0c29 0%, #302b63 100%);
            --primary: #a29bfe;
            --primary-grad: linear-gradient(135deg, #6c5ce7 0%, #fd79a8 100%);
            --secondary: #81ecec;
            --text-main: #dfe6e9;
            --text-muted: #b2bec3;
            --card-bg: #2d2d44;
            --input-bg: #363650;
            --border: #40405a;
            --shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Nunito', sans-serif; }
        html { scroll-behavior: smooth; }
        
        body {
            background: var(--bg-color);
            color: var(--text-main);
            transition: background 0.3s, color 0.3s;
            overflow-x: hidden;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            font-size: clamp(0.9rem, 2vw, 1rem);
            line-height: 1.6;
        }

        .container { width: 100%; max-width: 1200px; margin: 0 auto; padding: 0 var(--container-padding); }
        
        .btn {
            padding: clamp(10px, 2.5vw, 12px) clamp(20px, 5vw, 24px);
            border-radius: 50px;
            border: none;
            cursor: pointer;
            font-weight: 700;
            transition: transform 0.2s, box-shadow 0.2s;
            font-size: clamp(0.9rem, 2vw, 0.95rem);
            min-height: 44px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary { background: var(--primary-grad); color: white; box-shadow: 0 4px 15px rgba(108, 92, 231, 0.3); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(108, 92, 231, 0.4); }
        .btn-primary:active { transform: translateY(0); }
        
        .btn-danger { background: rgba(255, 118, 117, 0.1); color: var(--danger); border: 1px solid var(--danger); }
        .btn-danger:hover { background: var(--danger); color: white; }
        
        .btn-sm { padding: 6px 16px; font-size: 0.85rem; min-height: 36px; }
        .btn-success { background: var(--success); color: white; }
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }
        .btn-outline:hover { background: var(--primary); color: white; }
        
        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.5s ease forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* Navbar */
        nav {
            position: fixed; top: 0; width: 100%; z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border);
            padding: 12px 0;
            transition: background 0.3s;
        }
        [data-theme="dark"] nav { background: rgba(30, 30, 46, 0.9); }
        
        .nav-content { display: flex; justify-content: space-between; align-items: center; padding: 0 var(--container-padding); }
        
        .logo { 
            font-size: clamp(1.3rem, 4vw, 1.5rem); 
            font-weight: 800; 
            background: var(--primary-grad); 
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent; 
            text-decoration: none; 
        }
        
        .nav-links { display: flex; gap: clamp(15px, 3vw, 20px); align-items: center; list-style: none; }
        .nav-links a { 
            text-decoration: none; 
            color: var(--text-main); 
            font-weight: 600; 
            font-size: clamp(0.9rem, 2vw, 0.95rem); 
            transition: color 0.2s;
            padding: 8px 4px;
        }
        .nav-links a:hover { color: var(--primary); }
        
        .theme-toggle { 
            background: none; border: none; font-size: 1.3rem; cursor: pointer; color: var(--text-main);
            min-width: 44px; min-height: 44px; display: flex; align-items: center; justify-content: center;
            border-radius: 50%; transition: background 0.2s;
        }
        .theme-toggle:hover { background: var(--input-bg); }

        .hamburger {
            display: none; flex-direction: column; gap: 5px; background: none; border: none;
            cursor: pointer; padding: 8px; min-width: 44px; min-height: 44px;
            justify-content: center; align-items: center;
        }
        .hamburger span { width: 24px; height: 3px; background: var(--text-main); border-radius: 2px; transition: all 0.3s; }
        .hamburger.active span:nth-child(1) { transform: rotate(45deg) translate(5px, 5px); }
        .hamburger.active span:nth-child(2) { opacity: 0; }
        .hamburger.active span:nth-child(3) { transform: rotate(-45deg) translate(5px, -5px); }

        /* Hero */
        .hero {
            padding: clamp(120px, 25vw, 160px) 0 clamp(60px, 15vw, 80px);
            text-align: center;
            background: radial-gradient(circle at 50% 10%, rgba(108, 92, 231, 0.1) 0%, transparent 60%);
        }
        .hero h1 { font-size: clamp(2rem, 8vw, 3.5rem); margin-bottom: clamp(15px, 3vw, 20px); line-height: 1.1; color: var(--text-main); word-wrap: break-word; }
        .hero p { font-size: clamp(1rem, 3vw, 1.2rem); color: var(--text-muted); max-width: 600px; margin: 0 auto clamp(25px, 5vw, 40px); padding: 0 10px; }

        /* Filter Tabs */
        .filter-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .filter-tab {
            padding: 8px 20px;
            border-radius: 50px;
            border: 2px solid var(--border);
            background: var(--card-bg);
            color: var(--text-muted);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 44px;
        }
        .filter-tab:hover { border-color: var(--primary); color: var(--primary); }
        .filter-tab.active {
            background: var(--primary-grad);
            color: white;
            border-color: transparent;
        }

        /* Main Layout */
        .main-layout { display: grid; grid-template-columns: 1fr 1.2fr; gap: clamp(20px, 4vw, 40px); padding-bottom: clamp(40px, 8vw, 60px); align-items: start; }
        
        .form-card {
            background: var(--card-bg); padding: clamp(20px, 4vw, 30px); border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow); position: sticky; top: 80px; height: fit-content; z-index: 10;
        }
        
        .form-group { margin-bottom: clamp(15px, 3vw, 20px); }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 700; font-size: 0.9rem; color: var(--text-muted); }
        .form-control {
            width: 100%; padding: clamp(10px, 2.5vw, 12px) clamp(12px, 3vw, 15px); border-radius: var(--border-radius-md);
            border: 2px solid var(--border); background: var(--input-bg); color: var(--text-main);
            font-size: 1rem; transition: all 0.3s; min-height: 44px;
        }
        .form-control:focus { outline: none; border-color: var(--primary); background: var(--card-bg); box-shadow: 0 0 0 3px rgba(108, 92, 231, 0.1); }
        textarea.form-control { resize: vertical; min-height: clamp(100px, 20vw, 120px); }
        select.form-control { cursor: pointer; }

        /* Curhat List */
        .curhat-list { display: flex; flex-direction: column; gap: clamp(20px, 4vw, 25px); }
        .curhat-card {
            background: var(--card-bg); padding: clamp(20px, 4vw, 25px); border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow); border: 1px solid transparent; transition: all 0.3s;
            position: relative; overflow: hidden;
        }
        .curhat-card:hover { transform: translateY(-3px); box-shadow: 0 15px 35px rgba(0,0,0,0.1); border-color: rgba(108, 92, 231, 0.2); }
        .curhat-card.is-owner { border-left: 4px solid var(--primary); }
        
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
        .badge { padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap; }
        .badge-sedih { background: #ffeaa7; color: #d35400; }
        .badge-marah { background: #ff7675; color: white; }
        .badge-bahagia { background: #55efc4; color: #00b894; }
        .badge-galau { background: #a29bfe; color: white; }
        .badge-lainnya { background: #dfe6e9; color: #636e72; }
        .badge-owner { background: var(--primary-grad); color: white; }
        
        .card-title { font-size: clamp(1.1rem, 3vw, 1.2rem); font-weight: 800; margin-bottom: 5px; color: var(--text-main); word-wrap: break-word; }
        .card-meta { font-size: 0.85rem; color: var(--text-muted); margin-bottom: 15px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .card-content { color: var(--text-main); line-height: 1.7; white-space: pre-wrap; margin-bottom: 20px; word-wrap: break-word; overflow-wrap: break-word; }
        
        .card-footer { display: flex; justify-content: space-between; align-items: center; border-top: 1px solid var(--border); padding-top: 15px; flex-wrap: wrap; gap: 10px; }
        .like-btn { background: none; border: none; cursor: pointer; display: flex; align-items: center; gap: 8px; color: var(--text-muted); font-weight: 700; transition: color 0.2s; min-height: 44px; padding: 0 12px; }
        .like-btn:hover, .like-btn.liked { color: var(--danger); }
        
        .admin-reply-box, .owner-reply-box { 
            margin-top: 15px; padding: clamp(12px, 3vw, 15px); background: var(--input-bg); 
            border-radius: var(--border-radius-md); font-size: 0.9rem; word-wrap: break-word;
        }
        .admin-reply-box { border-left: 3px solid var(--primary); }
        .owner-reply-box { border-left: 3px solid var(--success); }
        .reply-box-title { font-weight: 700; margin-bottom: 5px; display: flex; align-items: center; gap: 5px; }

        /* Reply Form for Owner */
        .owner-reply-form {
            margin-top: 15px;
            padding: 15px;
            background: var(--input-bg);
            border-radius: var(--border-radius-md);
            border: 2px dashed var(--border);
        }
        .owner-reply-form textarea {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--card-bg);
            color: var(--text-main);
            font-size: 0.9rem;
            min-height: 60px;
            resize: vertical;
            margin-bottom: 10px;
        }
        .owner-reply-form textarea:focus { outline: none; border-color: var(--success); }

        /* Notification Badge */
        .notification-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--danger);
            color: white;
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 700;
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }

        /* Admin Dashboard */
        .dashboard-section { padding: clamp(100px, 20vw, 120px) 0 clamp(40px, 8vw, 60px); }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: clamp(15px, 3vw, 20px); margin-bottom: clamp(30px, 6vw, 40px); }
        .stat-card { background: var(--card-bg); padding: clamp(20px, 4vw, 25px); border-radius: var(--border-radius-md); box-shadow: var(--shadow); text-align: center; }
        .stat-number { font-size: clamp(1.8rem, 6vw, 2.5rem); font-weight: 800; color: var(--primary); margin-bottom: 5px; }
        .stat-label { color: var(--text-muted); font-weight: 600; font-size: 0.9rem; }
        
        .admin-table-container { background: var(--card-bg); border-radius: var(--border-radius-lg); box-shadow: var(--shadow); overflow: hidden; }
        .admin-header { padding: clamp(15px, 3vw, 20px); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .curhat-item-row { padding: clamp(15px, 3vw, 20px); border-bottom: 1px solid var(--border); display: flex; flex-direction: column; gap: 10px; }
        .curhat-item-row:last-child { border-bottom: none; }
        .row-actions { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
        .row-actions .btn { flex: 1; min-width: 100px; }

        /* Modal */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
            z-index: 2000; display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
            padding: var(--container-padding);
        }
        .modal.active { opacity: 1; pointer-events: all; }
        .modal-content {
            background: var(--card-bg); padding: clamp(25px, 5vw, 40px); border-radius: var(--border-radius-lg);
            width: 100%; max-width: 400px; text-align: center;
            transform: scale(0.9); transition: transform 0.3s;
            max-height: 90vh; overflow-y: auto;
        }
        .modal.active .modal-content { transform: scale(1); }
        .modal h2 { margin-bottom: clamp(15px, 3vw, 20px); color: var(--primary); font-size: clamp(1.3rem, 4vw, 1.5rem); }

        /* Toast */
        .toast {
            position: fixed; bottom: clamp(15px, 3vw, 30px); right: clamp(15px, 3vw, 30px);
            left: clamp(15px, 3vw, auto);
            background: var(--card-bg); color: var(--text-main);
            padding: clamp(12px, 3vw, 15px) clamp(20px, 4vw, 25px); border-radius: var(--border-radius-md);
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            display: flex; align-items: center; gap: 10px;
            transform: translateY(100px); opacity: 0; transition: all 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            z-index: 3000; border-left: 5px solid var(--success);
            max-width: calc(100% - 30px); word-wrap: break-word;
        }
        .toast.show { transform: translateY(0); opacity: 1; }

        /* Accessibility */
        input:focus-visible, textarea:focus-visible, select:focus-visible, button:focus-visible {
            outline: 2px solid var(--primary); outline-offset: 2px;
        }

        /* Delete animation */
        .curhat-card.deleting { animation: slideOut 0.3s ease forwards; }
        @keyframes slideOut { to { opacity: 0; transform: translateX(100px) scale(0.9); } }

        /* Responsive */
        @media (max-width: 1024px) {
            .main-layout { grid-template-columns: 1fr; gap: 30px; }
            .form-card { position: static; margin-bottom: 20px; }
        }
        @media (max-width: 768px) {
            :root { --container-padding: 16px; }
            .hamburger { display: flex; }
            .nav-links {
                position: fixed; top: 60px; left: 0; right: 0;
                background: var(--card-bg); flex-direction: column;
                padding: 20px; gap: 15px; box-shadow: var(--shadow);
                transform: translateY(-150%); transition: transform 0.3s ease;
                z-index: 999; border-bottom: 1px solid var(--border);
            }
            .nav-links.active { transform: translateY(0); }
            .nav-links a { padding: 12px; font-size: 1.1rem; border-radius: var(--border-radius-sm); }
            .nav-links a:hover { background: var(--input-bg); }
            .hero { padding: 100px 0 50px; }
            .form-card, .curhat-card { padding: 20px 16px; }
            .card-header, .card-footer { flex-direction: column; align-items: flex-start; }
            .like-btn { width: 100%; justify-content: center; }
            .admin-header { flex-direction: column; align-items: stretch; text-align: center; }
            .row-actions { flex-direction: column; }
            .row-actions .btn { width: 100%; }
            .modal-content { margin: 10px; padding: 25px 20px; }
            .toast { left: 15px; right: 15px; bottom: 15px; justify-content: center; text-align: center; }
        }
        @media (max-width: 480px) {
            :root { --container-padding: 12px; --border-radius-lg: 16px; --border-radius-md: 10px; }
            .btn { width: 100%; justify-content: center; }
            .btn:not(.btn-sm) { min-height: 48px; }
            .hero h1 { font-size: 1.8rem; }
            .form-control { font-size: 1rem; }
            body { overflow-x: hidden; width: 100%; }
        }
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
            html { scroll-behavior: auto; }
        }
        @media (prefers-color-scheme: dark) {
            body:not([data-theme="light"]) {
                --bg-color: #1e1e2e; --bg-gradient: linear-gradient(135deg, #0f0c29 0%, #302b63 100%);
                --primary: #a29bfe; --primary-grad: linear-gradient(135deg, #6c5ce7 0%, #fd79a8 100%);
                --secondary: #81ecec; --text-main: #dfe6e9; --text-muted: #b2bec3;
                --card-bg: #2d2d44; --input-bg: #363650; --border: #40405a;
                --shadow: 0 10px 30px rgba(0,0,0,0.3);
            }
        }
    </style>
</head>
<body>

    <!-- Navbar -->
    <nav>
        <div class="container nav-content">
            <a href=":/a319abca-8339-469f-a957-0a363f5d6d9b.png" class="logo" onclick="showPublicView(); closeMobileMenu()">RuangCurhat.</a>
            <button class="hamburger" id="hamburger" aria-label="Toggle menu" aria-expanded="false">
                <span></span><span></span><span></span>
            </button>
            <ul class="nav-links" id="navLinks">
                <li><a href="#" onclick="showPublicView('all'); closeMobileMenu()">Semua Curhat</a></li>
                <li><a href="#" onclick="showPublicView('mine'); closeMobileMenu()">Curhat Saya</a></li>
                <li id="navAdminLink"><a href="#" onclick="openLoginModal(); closeMobileMenu()">Login Admin</a></li>
                <li id="navDashboardLink" class="hidden"><a href="#" onclick="showDashboard(); closeMobileMenu()">Dashboard</a></li>
                <li id="navLogoutLink" class="hidden"><a href="#" onclick="logoutAdmin(); closeMobileMenu()" style="color: var(--danger)">Logout</a></li>
            </ul>
            <button class="theme-toggle" id="themeToggle" title="Ganti Tema" aria-label="Toggle dark mode">üåô</button>
        </div>
    </nav>

    <!-- PUBLIC VIEW -->
    <div id="publicView">
        <section class="hero">
            <div class="container">
                <h1>Semua Cerita<br>Pantas Didengar</h1>
                <p>Ruang aman untuk melepaskan beban. Anonim, rahasia, dan penuh empati.</p>
                <a href="#curhat" class="btn btn-primary" onclick="closeMobileMenu()">Mulai Curhat Sekarang</a>
            </div>
        </section>
        <section id="curhat" class="container">
            <div class="main-layout">
                <div class="form-card fade-in">
                    <h2 style="margin-bottom: 20px; font-size: clamp(1.3rem, 4vw, 1.5rem);">Tulis Ceritamu</h2>
                    <form id="curhatForm">
                        <div class="form-group">
                            <label for="name">Nama (Opsional)</label>
                            <input type="text" id="name" class="form-control" placeholder="Anonim jika kosong" autocomplete="name">
                        </div>
                        <div class="form-group">
                            <label for="title">Judul</label>
                            <input type="text" id="title" class="form-control" placeholder="Singkat & Jelas" required autocomplete="off">
                        </div>
                        <div class="form-group">
                            <label for="category">Kategori</label>
                            <select id="category" class="form-control">
                                <option value="galau">Galau</option>
                                <option value="sedih">Sedih</option>
                                <option value="marah">Marah</option>
                                <option value="bahagia">Bahagia</option>
                                <option value="lainnya">Lainnya</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="content">Isi Cerita</label>
                            <textarea id="content" class="form-control" placeholder="Ceritakan apa yang terjadi..." required></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary" style="width: 100%;">Kirim Cerita</button>
                    </form>
                </div>
                <div>
                    <!-- Filter Tabs -->
                    <div class="filter-tabs">
                        <button class="filter-tab active" onclick="setFilter('all')" id="filterAll">üìã Semua</button>
                        <button class="filter-tab" onclick="setFilter('mine')" id="filterMine">üë§ Curhat Saya</button>
                    </div>
                    <div class="curhat-list" id="curhatList"></div>
                </div>
            </div>
        </section>
    </div>

    <!-- ADMIN DASHBOARD VIEW -->
    <div id="adminView" class="hidden dashboard-section container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; gap: 10px;">
            <h1 style="font-size: clamp(1.5rem, 5vw, 2rem);">Dashboard Admin</h1>
            <span class="badge" style="background: var(--primary); color: white; padding: 8px 16px; font-size: 0.85rem;">Mode Admin Aktif</span>
        </div>
        <div class="stats-grid">
            <div class="stat-card"><div class="stat-number" id="statTotal">0</div><div class="stat-label">Total Curhatan</div></div>
            <div class="stat-card"><div class="stat-number" id="statLikes">0</div><div class="stat-label">Total Like</div></div>
            <div class="stat-card"><div class="stat-number" id="statToday">0</div><div class="stat-label">Hari Ini</div></div>
        </div>
        <div class="admin-table-container">
            <div class="admin-header">
                <h3 style="font-size: 1.2rem;">Daftar Semua Curhatan</h3>
                <button class="btn btn-sm btn-danger" onclick="clearAllData()">Reset Semua Data</button>
            </div>
            <div id="adminListContainer"></div>
        </div>
    </div>

    <!-- Login Modal -->
    <div class="modal" id="loginModal" role="dialog" aria-modal="true" aria-labelledby="loginTitle">
        <div class="modal-content">
            <h2 id="loginTitle">Login Admin</h2>
            <form id="loginForm">
                <div class="form-group" style="text-align: left;">
                    <label for="adminUser">Username</label>
                    <input type="text" id="adminUser" class="form-control" required autocomplete="username">
                </div>
                <div class="form-group" style="text-align: left;">
                    <label for="adminPass">Password</label>
                    <input type="password" id="adminPass" class="form-control" required autocomplete="current-password">
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Masuk</button>
                <button type="button" class="btn" style="width: 100%; margin-top: 10px; background: transparent; color: var(--text-muted);" onclick="closeLoginModal()">Batal</button>
            </form>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast" role="alert" aria-live="polite">
        <span>‚úÖ</span><span id="toastMsg">Berhasil!</span>
    </div>

    <script>
        // --- State & Data ---
        let curhats = JSON.parse(localStorage.getItem('curhats')) || [];
        let isAdmin = localStorage.getItem('isAdmin') === 'true';
        let currentFilter = 'all'; // 'all' or 'mine'

        // Generate/Get owner token for device identification
        function getOwnerToken() {
            let token = localStorage.getItem('ownerToken');
            if (!token) {
                token = 'user_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
                localStorage.setItem('ownerToken', token);
            }
            return token;
        }
        const MY_TOKEN = getOwnerToken();

        // --- DOM Elements ---
        const publicView = document.getElementById('publicView');
        const adminView = document.getElementById('adminView');
        const navAdminLink = document.getElementById('navAdminLink');
        const navDashboardLink = document.getElementById('navDashboardLink');
        const navLogoutLink = document.getElementById('navLogoutLink');
        const loginModal = document.getElementById('loginModal');
        const themeToggle = document.getElementById('themeToggle');
        const toast = document.getElementById('toast');
        const hamburger = document.getElementById('hamburger');
        const navLinks = document.getElementById('navLinks');

        // --- Mobile Menu ---
        hamburger?.addEventListener('click', () => {
            hamburger.classList.toggle('active');
            navLinks.classList.toggle('active');
            hamburger.setAttribute('aria-expanded', hamburger.classList.contains('active'));
        });
        function closeMobileMenu() {
            hamburger?.classList.remove('active');
            navLinks?.classList.remove('active');
            hamburger?.setAttribute('aria-expanded', 'false');
        }
        document.addEventListener('click', (e) => {
            if (!hamburger?.contains(e.target) && !navLinks?.contains(e.target) && navLinks?.classList.contains('active')) closeMobileMenu();
        });
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') { closeMobileMenu(); closeLoginModal(); } });

        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
            renderPublicFeed();
            checkAdminSession();
            loadTheme();
            checkNotifications();
            
            // Prevent iOS zoom on input focus
            document.querySelectorAll('input, textarea, select').forEach(input => {
                input.addEventListener('focus', function() {
                    if (window.innerWidth < 768) {
                        const meta = document.querySelector('meta[name="viewport"]');
                        if (meta) meta.setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no');
                    }
                });
                input.addEventListener('blur', function() {
                    const meta = document.querySelector('meta[name="viewport"]');
                    if (meta) meta.setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=5.0');
                });
            });
        });

        // --- Navigation ---
        function showPublicView(filter = 'all') {
            publicView.classList.remove('hidden');
            adminView.classList.add('hidden');
            currentFilter = filter;
            updateFilterTabs();
            renderPublicFeed();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        function showDashboard() {
            if(!isAdmin) { openLoginModal(); return; }
            publicView.classList.add('hidden');
            adminView.classList.remove('hidden');
            renderAdminDashboard();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        function checkAdminSession() {
            if(isAdmin) {
                navAdminLink?.classList.add('hidden');
                navDashboardLink?.classList.remove('hidden');
                navLogoutLink?.classList.remove('hidden');
            } else {
                navAdminLink?.classList.remove('hidden');
                navDashboardLink?.classList.add('hidden');
                navLogoutLink?.classList.add('hidden');
            }
        }

        // --- Filter Tabs ---
        function setFilter(filter) {
            currentFilter = filter;
            updateFilterTabs();
            renderPublicFeed();
        }
        
        function updateFilterTabs() {
            const filterAll = document.getElementById('filterAll');
            const filterMine = document.getElementById('filterMine');
            if(filterAll && filterMine) {
                filterAll.classList.toggle('active', currentFilter === 'all');
                filterMine.classList.toggle('active', currentFilter === 'mine');
            }
        }

        // --- Submit Curhat ---
        document.getElementById('curhatForm')?.addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('name').value.trim() || 'Anonim';
            const title = document.getElementById('title').value.trim();
            const category = document.getElementById('category').value;
            const content = document.getElementById('content').value.trim();
            const newCurhat = {
                id: Date.now().toString(),
                name, title, category, content,
                timestamp: new Date().toISOString(),
                likes: 0,
                likedByMe: false,
                adminRead: false,
                adminReply: null,
                ownerReply: null,
                ownerToken: MY_TOKEN,
                notifications: { newLike: false, adminReply: false }
            };
            curhats.unshift(newCurhat);
            saveData();
            renderPublicFeed();
            e.target.reset();
            showToast('Curhatan berhasil dikirim! ‚ú®');
        });

        // --- Render Public Feed ---
        function renderPublicFeed() {
            const list = document.getElementById('curhatList');
            if(!list) return;
            list.innerHTML = '';
            
            // Filter curhats
            let filteredCurhats = curhats;
            if(currentFilter === 'mine') {
                filteredCurhats = curhats.filter(item => item.ownerToken === MY_TOKEN);
            }
            
            if(filteredCurhats.length === 0) {
                const msg = currentFilter === 'mine' 
                    ? 'Kamu belum punya curhatan. Yuk tulis ceritamu! ‚úçÔ∏è'
                    : 'Belum ada cerita. Jadilah yang pertama! ‚ú®';
                list.innerHTML = `<div style="text-align:center; padding:40px; color:var(--text-muted); font-size: clamp(0.9rem, 3vw, 1rem);">${msg}</div>`;
                return;
            }

            filteredCurhats.forEach(item => {
                const date = new Date(item.timestamp).toLocaleDateString('id-ID', { day:'numeric', month:'short', hour:'2-digit', minute:'2-digit' });
                const isOwner = item.ownerToken === MY_TOKEN || isAdmin;
                
                // Check for notifications
                let notificationBadge = '';
                if(isOwner && !isAdmin) {
                    if(item.notifications?.adminReply && !item.adminReplySeen) {
                        notificationBadge = '<span class="notification-badge">üîî Admin Balas!</span>';
                    }
                }
                
                const card = document.createElement('div');
                card.className = 'curhat-card fade-in' + (isOwner ? ' is-owner' : '');
                card.innerHTML = `
                    ${notificationBadge}
                    <div class="card-header">
                        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                            <span class="badge badge-${item.category}">${item.category}</span>
                            ${isOwner ? '<span class="badge badge-owner">üë§ Milik Saya</span>' : ''}
                        </div>
                        <span style="font-size:0.8rem; color:var(--text-muted); white-space:nowrap">${date}</span>
                    </div>
                    <div class="card-title">${escapeHtml(item.title)}</div>
                    <div class="card-meta">
                        <span>üë§ ${escapeHtml(item.name)}</span>
                        ${item.adminRead ? '<span style="color:var(--success); font-size:0.75rem">‚úÖ Sudah Dibaca Admin</span>' : ''}
                    </div>
                    <div class="card-content">${escapeHtml(item.content)}</div>
                    ${item.adminReply ? `<div class="admin-reply-box"><div class="reply-box-title">üë®‚Äçüíº Respon Admin:</div>${escapeHtml(item.adminReply)}</div>` : ''}
                    ${item.ownerReply ? `<div class="owner-reply-box"><div class="reply-box-title">‚úèÔ∏è Respon Pemilik:</div>${escapeHtml(item.ownerReply)}</div>` : ''}
                    <div class="card-footer">
                        <button class="like-btn ${item.likedByMe ? 'liked' : ''}" onclick="toggleLike('${item.id}')" aria-label="${item.likedByMe ? 'Batal suka' : 'Suka'}">
                            <span aria-hidden="true">${item.likedByMe ? '‚ù§Ô∏è' : 'ü§ç'}</span><span>${item.likes}</span>
                        </button>
                        <div style="display:flex; gap:10px; flex-wrap:wrap;">
                            ${isOwner ? `
                                <button class="btn btn-sm btn-outline" onclick="showOwnerReplyForm('${item.id}')" aria-label="Balas curhatan ini">
                                    üí¨ Balas
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteCurhatPublic('${item.id}')" aria-label="Hapus curhatan ini">
                                    üóëÔ∏è Hapus
                                </button>
                            ` : ''}
                        </div>
                    </div>
                    ${isOwner ? `
                        <div class="owner-reply-form hidden" id="replyForm-${item.id}">
                            <textarea id="ownerReply-${item.id}" placeholder="Tulis balasan kamu..."></textarea>
                            <div style="display:flex; gap:10px; flex-wrap:wrap;">
                                <button class="btn btn-sm btn-success" onclick="saveOwnerReply('${item.id}')">üíæ Kirim Balasan</button>
                                <button class="btn btn-sm" style="background:var(--text-muted); color:white;" onclick="hideOwnerReplyForm('${item.id}')">Batal</button>
                            </div>
                        </div>
                    ` : ''}
                `;
                list.appendChild(card);
            });
        }

        // --- Show/Hide Owner Reply Form ---
        window.showOwnerReplyForm = (id) => {
            const form = document.getElementById(`replyForm-${id}`);
            if(form) form.classList.remove('hidden');
        };
        
        window.hideOwnerReplyForm = (id) => {
            const form = document.getElementById(`replyForm-${id}`);
            if(form) form.classList.add('hidden');
        };

        // --- Save Owner Reply ---
        window.saveOwnerReply = (id) => {
            const input = document.getElementById(`ownerReply-${id}`);
            const item = curhats.find(c => c.id === id);
            if(item && input?.value.trim()) {
                item.ownerReply = input.value.trim();
                saveData();
                hideOwnerReplyForm(id);
                renderPublicFeed();
                showToast('Balasan berhasil dikirim! üí¨');
            }
        };

        // --- Like Toggle ---
        window.toggleLike = (id) => {
            const item = curhats.find(c => c.id === id);
            if(!item) return;
            
            const wasLiked = item.likedByMe;
            if(wasLiked) {
                item.likes--;
                item.likedByMe = false;
            } else {
                item.likes++;
                item.likedByMe = true;
                // Set notification for owner if someone else likes
                if(item.ownerToken !== MY_TOKEN) {
                    if(!item.notifications) item.notifications = {};
                    item.notifications.newLike = true;
                }
            }
            saveData();
            renderPublicFeed();
            if(isAdmin) renderAdminDashboard();
        };

        // --- Check Notifications ---
        function checkNotifications() {
            curhats.forEach(item => {
                if(item.ownerToken === MY_TOKEN && !isAdmin) {
                    // Check for new admin reply
                    if(item.adminReply && !item.adminReplySeen) {
                        item.notifications = item.notifications || {};
                        item.notifications.adminReply = true;
                    }
                }
            });
            saveData();
        }

        // --- Mark Notification as Seen ---
        window.markNotificationSeen = (id) => {
            const item = curhats.find(c => c.id === id);
            if(item && item.notifications) {
                item.notifications.adminReply = false;
                item.adminReplySeen = true;
                saveData();
            }
        };

        // --- Delete: Public (owner only) ---
        window.deleteCurhatPublic = (id) => {
            const item = curhats.find(c => c.id === id);
            if (!item || (item.ownerToken !== MY_TOKEN && !isAdmin)) {
                showToast('‚ùå Tidak diizinkan');
                return;
            }
            if(confirm('Yakin ingin menghapus curhatan ini?\n\nTindakan ini tidak bisa dibatalkan.')) {
                const card = [...document.querySelectorAll('.curhat-card')].find(el => 
                    el.querySelector('.card-title')?.textContent === item.title
                );
                if(card) {
                    card.classList.add('deleting');
                    setTimeout(() => { doDelete(id); }, 300);
                } else {
                    doDelete(id);
                }
            }
        };
        
        function doDelete(id) {
            curhats = curhats.filter(c => c.id !== id);
            saveData();
            renderPublicFeed();
            if(isAdmin) renderAdminDashboard();
            showToast('Curhatan berhasil dihapus üóëÔ∏è');
        }

        // --- Admin: Login/Logout ---
        function openLoginModal() {
            loginModal.classList.add('active');
            setTimeout(() => document.getElementById('adminUser')?.focus(), 100);
            document.body.style.overflow = 'hidden';
        }
        function closeLoginModal() {
            loginModal.classList.remove('active');
            document.body.style.overflow = '';
        }
        loginModal?.addEventListener('click', (e) => { if (e.target === loginModal) closeLoginModal(); });
        
        document.getElementById('loginForm')?.addEventListener('submit', (e) => {
            e.preventDefault();
            const u = document.getElementById('adminUser').value;
            const p = document.getElementById('adminPass').value;
            if(u === 'Furqon' && p === '161010') {
                isAdmin = true;
                localStorage.setItem('isAdmin', 'true');
                checkAdminSession();
                closeLoginModal();
                showDashboard();
                showToast('Login Admin Berhasil');
                e.target.reset();
            } else {
                alert('Username atau Password salah!');
            }
        });
        
        window.logoutAdmin = () => {
            isAdmin = false;
            localStorage.setItem('isAdmin', 'false');
            checkAdminSession();
            showPublicView();
            showToast('Logout Berhasil');
        };

        // --- Admin: Dashboard ---
        function renderAdminDashboard() {
            const container = document.getElementById('adminListContainer');
            if(!container) return;
            
            document.getElementById('statTotal').innerText = curhats.length;
            document.getElementById('statLikes').innerText = curhats.reduce((a,c) => a + c.likes, 0);
            const today = new Date().toDateString();
            document.getElementById('statToday').innerText = curhats.filter(c => new Date(c.timestamp).toDateString() === today).length;
            
            container.innerHTML = '';
            if(curhats.length === 0) {
                container.innerHTML = '<div style="padding:20px; text-align:center; color:var(--text-muted)">Tidak ada data.</div>';
                return;
            }
            
            curhats.forEach(item => {
                const row = document.createElement('div');
                row.className = 'curhat-item-row';
                row.innerHTML = `
                    <div style="display:flex; justify-content:space-between; flex-wrap:wrap; gap:10px;">
                        <strong style="word-break:break-word">${escapeHtml(item.title)}</strong>
                        <span class="badge badge-${item.category}">${item.category}</span>
                    </div>
                    <div style="font-size:0.9rem; color:var(--text-muted); word-break:break-word">${escapeHtml(item.content)}</div>
                    <div style="font-size:0.8rem; color:var(--text-muted)">Oleh: ${escapeHtml(item.name)} | ${new Date(item.timestamp).toLocaleString('id-ID')}</div>
                    <div class="row-actions">
                        <button class="btn btn-sm ${item.adminRead ? 'btn-success' : 'btn-primary'}" style="background:${item.adminRead ? 'var(--success)' : 'var(--primary)'}; color:white" onclick="toggleRead('${item.id}')">${item.adminRead ? '‚úì Sudah Dibaca' : 'üìñ Tandai Dibaca'}</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteCurhat('${item.id}')">üóëÔ∏è Hapus</button>
                    </div>
                    <div style="margin-top:10px;">
                        <input type="text" id="reply-${item.id}" class="form-control" placeholder="Tulis respon admin..." value="${item.adminReply || ''}" style="font-size:0.85rem; padding:8px;">
                        <button class="btn btn-sm" style="margin-top:5px; background:var(--text-main); color:var(--bg-color); width:100%;" onclick="saveReply('${item.id}')">üíæ Simpan Respon</button>
                    </div>
                `;
                container.appendChild(row);
            });
        }
        
        window.toggleRead = (id) => {
            const item = curhats.find(c => c.id === id);
            if(item) {
                item.adminRead = !item.adminRead;
                saveData();
                renderAdminDashboard();
            }
        };
        
        window.saveReply = (id) => {
            const input = document.getElementById(`reply-${id}`);
            const item = curhats.find(c => c.id === id);
            if(item && input?.value.trim()) {
                item.adminReply = input.value.trim();
                item.adminReplySeen = false; // Reset seen status for owner notification
                saveData();
                showToast('Respon tersimpan');
                renderPublicFeed();
            }
        };
        
        window.deleteCurhat = (id) => {
            if(confirm('Hapus curhatan ini permanen?')) {
                curhats = curhats.filter(c => c.id !== id);
                saveData();
                renderAdminDashboard();
                renderPublicFeed();
                showToast('Curhatan dihapus');
            }
        };
        
        window.clearAllData = () => {
            if(confirm('‚ö†Ô∏è PERINGATAN: Ini akan menghapus SEMUA data curhatan. Lanjutkan?')) {
                curhats = [];
                saveData();
                renderAdminDashboard();
                renderPublicFeed();
                showToast('Semua data direset');
            }
        };

        // --- Utilities ---
        function saveData() { localStorage.setItem('curhats', JSON.stringify(curhats)); }
        function escapeHtml(text) { if (!text) return text; return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;"); }
        function showToast(msg) { const t = document.getElementById('toast'); if(t) { document.getElementById('toastMsg').innerText = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 3000); } }

        // --- Dark Mode ---
        themeToggle?.addEventListener('click', () => {
            const isDark = document.body.getAttribute('data-theme') === 'dark';
            document.body.setAttribute('data-theme', isDark ? 'light' : 'dark');
            themeToggle.innerText = isDark ? 'üåô' : '‚òÄÔ∏è';
            themeToggle.setAttribute('aria-label', isDark ? 'Aktifkan mode terang' : 'Aktifkan mode gelap');
            localStorage.setItem('theme', isDark ? 'light' : 'dark');
        });
        
        function loadTheme() {
            const theme = localStorage.getItem('theme');
            const systemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if(theme === 'dark' || (!theme && systemDark)) {
                document.body.setAttribute('data-theme', 'dark');
                themeToggle.innerText = '‚òÄÔ∏è';
                themeToggle.setAttribute('aria-label', 'Aktifkan mode terang');
            } else {
                document.body.setAttribute('data-theme', 'light');
                themeToggle.innerText = 'üåô';
                themeToggle.setAttribute('aria-label', 'Aktifkan mode gelap');
            }
        }
        
        window.matchMedia('(prefers-color-scheme: dark)')?.addEventListener('change', e => {
            if (!localStorage.getItem('theme')) {
                document.body.setAttribute('data-theme', e.matches ? 'dark' : 'light');
                themeToggle.innerText = e.matches ? '‚òÄÔ∏è' : 'üåô';
            }
        });
    </script>
</body>
</html>
